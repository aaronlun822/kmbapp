<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="UTF-8">
  <title>ä¹å·´åˆ°ç«™æŸ¥è©¢</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link rel="icon" type="image/svg+xml" href="icon.svg">
  <link rel="apple-touch-icon" href="./apple-touch-icon.png">

  <style>
    :root {
      --primary-color: #E3001B; /* KMB Red */
      --primary-dark: #b60016;
      --bg-color: #f2f4f6;
      --card-bg: #ffffff;
      --text-main: #333333;
      --text-sub: #666666;
      --accent-green: #00Bfa5;
      --shadow: 0 4px 12px rgba(0,0,0,0.08);
      --radius: 12px;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      margin: 0;
      background: var(--bg-color);
      color: var(--text-main);
      -webkit-font-smoothing: antialiased;
      padding-bottom: 40px;
    }

    /* å·¥å…·åˆ—å„ªåŒ– */
    #toolbar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      padding: 12px 16px;
      box-shadow: 0 1px 10px rgba(0,0,0,0.05);
      z-index: 1000;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }

    h1 {
      margin: 0;
      color: var(--primary-color);
      font-size: 20px;
      font-weight: 800;
      letter-spacing: 1px;
    }

    .input-group {
      display: flex;
      gap: 8px;
      width: 100%;
      max-width: 600px;
    }

    input {
      flex: 1;
      padding: 10px 15px;
      border: 1px solid #ddd;
      border-radius: 50px;
      font-size: 16px;
      outline: none;
      transition: all 0.3s;
      text-align: left;
      background: #f8f9fa;
    }

    input:focus {
      border-color: var(--primary-color);
      background: #fff;
      box-shadow: 0 0 0 3px rgba(227, 0, 27, 0.1);
    }

    .action-buttons {
      display: flex;
      gap: 8px;
      width: 100%;
      max-width: 600px;
      overflow-x: auto;
      padding-bottom: 2px; /* For scrollbar */
    }

    button {
      flex: 1;
      padding: 10px;
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 15px;
      font-weight: 600;
      white-space: nowrap;
      transition: transform 0.1s, background 0.2s;
      box-shadow: 0 2px 4px rgba(227, 0, 27, 0.2);
    }

    button:active {
      transform: scale(0.98);
    }

    button.secondary {
      background: #fff;
      color: var(--text-main);
      border: 1px solid #ddd;
      box-shadow: none;
    }

    #content {
      margin-top: 140px; /* Adjust based on toolbar height */
      padding: 10px;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
    }

    #stops h2 {
      font-size: 18px;
      color: var(--text-sub);
      text-align: center;
      margin-bottom: 20px;
      font-weight: 500;
    }

    /* è»Šç«™åˆ—è¡¨å¡ç‰‡åŒ– */
    .stop {
      position: relative;
      background: var(--card-bg);
      padding: 16px 16px 16px 40px; /* å·¦é‚Šç•™ä½çµ¦è·¯ç·šç·šæ¢ */
      border-radius: var(--radius);
      margin-bottom: 12px;
      box-shadow: var(--shadow);
      cursor: pointer;
      transition: all 0.2s ease;
      border: 1px solid transparent;
    }

    .stop:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0,0,0,0.12);
    }

    /* è·¯ç·šåœ–è¦–è¦ºå…ƒç´  (å·¦å´ç·šæ¢èˆ‡åœ“é») */
    .stop::before {
      content: '';
      position: absolute;
      left: 20px;
      top: 0;
      bottom: 0;
      width: 2px;
      background: #e0e0e0;
      z-index: 0;
    }
    
    .stop:first-child::before { top: 50%; } /* ç¬¬ä¸€ç«™ç·šæ¢å¾ä¸­é–“é–‹å§‹ */
    .stop:last-child::before { bottom: 50%; } /* æœ€å¾Œä¸€ç«™ç·šæ¢åˆ°ä¸­é–“çµæŸ */

    .stop::after {
      content: attr(data-seq);
      position: absolute;
      left: 11px;
      top: 50%;
      transform: translateY(-50%);
      width: 20px;
      height: 20px;
      background: #fff;
      border: 2px solid var(--primary-color);
      border-radius: 50%;
      z-index: 1;
      font-size: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--primary-color);
      font-weight: bold;
    }

    .stop-name {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-main);
      line-height: 1.4;
    }

    /* å±•é–‹æ™‚çš„é«˜äº® */
    .stop.highlight {
      border-color: var(--primary-color);
      background: #fff5f5;
    }
    .stop.highlight::after {
      background: var(--primary-color);
      color: white;
    }

    /* ETA è©³ç´°è³‡è¨Š */
    .eta-detail {
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px dashed #eee;
      max-height: 0;
      overflow: hidden;
      opacity: 0;
      transition: all 0.4s cubic-bezier(0.25, 1, 0.5, 1);
    }

    .eta-detail.expanding {
      max-height: 500px;
      opacity: 1;
    }

    .eta-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      padding: 8px 12px;
      background: #fff;
      border-radius: 8px;
      border: 1px solid #f0f0f0;
    }

    .eta-time {
      font-size: 20px;
      font-weight: 700;
      color: var(--primary-color);
      display: flex;
      align-items: baseline;
      gap: 4px;
    }
    
    .eta-time small {
      font-size: 12px;
      font-weight: 400;
      color: var(--text-sub);
    }

    .eta-dest {
      font-size: 13px;
      color: var(--text-sub);
      text-align: right;
    }

    .eta-dest span {
      display: block;
      font-size: 11px;
      color: #999;
    }

    /* æœå°‹ç«™åçµæœçš„å°æ¨™ç±¤ */
    .route-tag {
      display: inline-block;
      margin: 4px 4px 4px 0;
      padding: 4px 10px;
      background: #fff;
      border: 1px solid var(--primary-color);
      color: var(--primary-color);
      border-radius: 20px;
      font-size: 13px;
      font-weight: 500;
    }
    .route-tag:hover {
      background: var(--primary-color);
      color: white;
    }

    /* Loading Spinner */
    .loading {
      text-align: center;
      padding: 20px;
      color: var(--text-sub);
      display: none;
    }
    .loading.active { display: block; }
    
    .spinner {
      width: 24px;
      height: 24px;
      border: 3px solid #ddd;
      border-top-color: var(--primary-color);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 10px;
    }
	.switcher {
	  display: flex;
	  border: 1px solid #ddd;
	  border-radius: 50px;
	  overflow: hidden;
	}

	.switcher button {
	  flex: 1;
	  padding: 10px;
	  border: none;
	  background: #fff;
	  color: var(--text-main);
	  cursor: pointer;
	  font-size: 15px;
	  font-weight: 600;
	}

	.switcher button.active {
	  background: var(--primary-color);
	  color: #fff;
	}
	.switcher button:not(:last-child) {
	  border-right: 1px solid #ddd;
	}

    @keyframes spin { to { transform: rotate(360deg); } }

</style>
</head>
<body>
  <div id="toolbar">
    <h1>KMB åˆ°ç«™é å ±</h1>
<div class="input-group">
  <input type="text" id="route" placeholder="è¼¸å…¥è·¯ç·š (e.g. 1A) æˆ–ç«™å" onkeypress="handleEnter(event)">
  <div id="switcher" class="switcher">
    <button id="routeBtn" class="active" onclick="setSearchMode('route')">è·¯ç·š</button>
    <button id="stopBtn" onclick="setSearchMode('stop')">ç«™å</button>
  </div>
</div>

<div class="action-buttons">
  <button onclick="handleSearch()">ğŸ” æœå°‹</button>
  <button class="secondary" onclick="toggleDirection()">â‡… è½‰æ–¹å‘</button>
  <!-- æ–°å¢ï¼šã€Œæˆ‘çš„æ”¶è—ã€ -->
  <button class="secondary" onclick="showFavorites()">â­ æˆ‘çš„æ”¶è—</button>
</div>

  </div>

  <div id="content">
    <div id="loading" class="loading">
      <div class="spinner"></div>
      æ­£åœ¨è¼‰å…¥è³‡æ–™...
    </div>
    <div id="stops">
        <p style="text-align:center; color:#999; margin-top:50px;">
            è«‹è¼¸å…¥è·¯ç·šä¸¦é»æ“ŠæŸ¥è©¢<br>ğŸ‘†
        </p>
    </div>
  </div>

  <script>
    let currentDirection = 'outbound'; 
    const serviceType = 1;
    const countdownTimers = new Map();
	let searchMode = 'route';

// æ”¾åœ¨æœ€å‰é¢ï¼Œæ–¹ä¾¿å…¶ä»–å‡½å¼å‘¼å«
async function fetchWithRetry(url, retries = 2) {
  for (let i = 0; i < retries; i++) {
    try {
      const res = await fetch(url);
      if (!res.ok) throw new Error("API å›æ‡‰éŒ¯èª¤");
      return await res.json();
    } catch (err) {
      if (i === retries - 1) throw err; // æœ€å¾Œä¸€æ¬¡æ‰ä¸ŸéŒ¯
      await new Promise(r => setTimeout(r, 1000)); // ç­‰ 1 ç§’å†è©¦
    }
  }
}

// æ”¶è—å·¥å…·ï¼šå–å¾—èˆ‡å­˜æª”
function getFavorites() {
  return JSON.parse(localStorage.getItem("favorites") || "[]");
}
function saveFavorites(favs) {
  localStorage.setItem("favorites", JSON.stringify(favs));
}

// å”¯ä¸€éµï¼šä»¥è·¯ç·šç‚ºä¸»ï¼ˆrouteOnlyï¼‰
function makeKey(route) {
  return `routeOnly:${route}`;
}
function isFavoriteRoute(route) {
  const key = makeKey(route);
  return getFavorites().some(f => f.key === key);
}
function toggleFavoriteRoute(item) {
  const favs = getFavorites();
  const exists = favs.some(f => f.key === item.key);
  const next = exists ? favs.filter(f => f.key !== item.key) : [...favs, item];
  saveFavorites(next);
  return !exists; // true è¡¨ç¤ºç¾åœ¨å·²æ”¶è—
}

// UIè¼”åŠ©ï¼šç”Ÿæˆæ”¶è—æŒ‰éˆ•ï¼ˆåœ¨è·¯ç·šæ¨™ç±¤æ—ï¼‰
function createRouteFavoriteButton({ route, nameHTML }) {
  const btn = document.createElement('button');
  btn.className = 'secondary';
  btn.style.marginLeft = '6px';
  btn.style.padding = '4px 8px';
  btn.style.fontSize = '13px';

  const updateLabel = () => {
    btn.textContent = isFavoriteRoute(route) ? "âœ… å·²æ”¶è—" : "â­ æ”¶è—";
  };
  updateLabel();

  btn.onclick = (e) => {
    e.stopPropagation();
    const nowFav = toggleFavoriteRoute({
      key: makeKey(route),
      type: "routeOnly",
      route,
      name: nameHTML || route
    });
    btn.textContent = nowFav ? "âœ… å·²æ”¶è—" : "â­ æ”¶è—";
  };
  return btn;
}



function setSearchMode(mode) {
  searchMode = mode;
  document.getElementById('routeBtn').classList.toggle('active', mode === 'route');
  document.getElementById('stopBtn').classList.toggle('active', mode === 'stop');
}

function handleSearch() {
  if (searchMode === 'route') {
    getStops();
  } else {
    searchByStopName();
  }
}



    // è¼”åŠ©åŠŸèƒ½ï¼šæŒ‰ Enter æŸ¥è©¢
    function handleEnter(e) {
      if (e.key === 'Enter') handleSearch();
    }

    // è¼”åŠ©åŠŸèƒ½ï¼šé¡¯ç¤º/éš±è— Loading
    function showLoading(show) {
        const loader = document.getElementById('loading');
        const content = document.getElementById('stops');
        if (show) {
            loader.classList.add('active');
            content.style.opacity = '0.5';
        } else {
            loader.classList.remove('active');
            content.style.opacity = '1';
        }
    }

    async function getStopName(stopId) {
      const url = `https://data.etabus.gov.hk/v1/transport/kmb/stop/${stopId}`;
      try {
        const response = await fetch(url);
        const data = await response.json();
        if (data.data) {
          return `${data.data.name_tc} <span style="font-size:0.8em; color:#888;">${data.data.name_en}</span>`;
        }
        return stopId;
      } catch (error) {
        return stopId;
      }
    }

    async function getStops(highlightStopId = null) {
      const route = document.getElementById('route').value.trim().toUpperCase();
      if (!route) {
          alert("è«‹è¼¸å…¥è·¯ç·šè™Ÿç¢¼");
          return;
      }

      showLoading(true);
      const stopsDiv = document.getElementById('stops');
      stopsDiv.innerHTML = ""; // æ¸…ç©º

      try {
        // å–å¾—è·¯ç·šåŸºæœ¬è³‡æ–™
        const routeInfoUrl = `https://data.etabus.gov.hk/v1/transport/kmb/route/${route}/${currentDirection}/${serviceType}`;
        const routeInfoRes = await fetch(routeInfoUrl);
        const routeInfoData = await routeInfoRes.json();
        
        let titleText = `è·¯ç·š ${route}`;
        if (routeInfoData.data) {
            titleText = `<div style="display:flex; justify-content:center; align-items:center; gap:10px;">
                <span>${routeInfoData.data.orig_tc}</span> 
                <span style="font-size:1.2em; color:var(--primary-color);">âœ</span> 
                <span>${routeInfoData.data.dest_tc}</span>
            </div>`;
        }

        // å–å¾—è©²è·¯ç·šçš„è»Šç«™åˆ—è¡¨
        const url = `https://data.etabus.gov.hk/v1/transport/kmb/route-stop/${route}/${currentDirection}/${serviceType}`;
        const response = await fetch(url);
        const data = await response.json();

        stopsDiv.innerHTML = `<h2>${titleText}</h2>`;

        if (data.data && data.data.length > 0) {
          // ç‚ºäº†æ•ˆèƒ½ï¼Œæˆ‘å€‘å¯ä»¥å…ˆ Render æ¡†æ¶ï¼Œå†éåŒæ­¥å¡«å…¥ç«™åï¼Œæˆ–è€…ä¸€æ¬¡è™•ç†
          // é€™è£¡ç°¡å–®å„ªåŒ–ï¼šä¸¦è¡Œç²å–ç«™å (å¦‚æœè»Šç«™å¾ˆå¤šå¯èƒ½æœƒæœ‰äº›å¾®å»¶é²ï¼Œä½†åœ¨å¯æ¥å—ç¯„åœ)
          
          for (const stop of data.data) {
            // æ³¨æ„ï¼šé€å€‹ await æœƒæ…¢ï¼Œé€™è£¡ä¿æŒåŸé‚è¼¯ä½†å»ºè­°ä¹‹å¾Œå„ªåŒ–ã€‚
            // ç‚ºäº†è¦–è¦ºæµæš¢ï¼Œæˆ‘å€‘å…ˆå‰µå»ºå…ƒç´ 
            const stopNameHTML = await getStopName(stop.stop);
            
            const stopDiv = document.createElement('div');
            stopDiv.className = 'stop';
            stopDiv.setAttribute('data-seq', stop.seq); // ç”¨æ–¼ CSS é¡¯ç¤ºåºè™Ÿ
            stopDiv.innerHTML = `<div class="stop-name">${stopNameHTML}</div>`;
            stopDiv.onclick = () => getETA(stop.stop, route, stopDiv, currentDirection === 'outbound' ? 'O' : 'I');
            stopsDiv.appendChild(stopDiv);

            if (highlightStopId && stop.stop === highlightStopId) {
              getETA(stop.stop, route, stopDiv, currentDirection === 'outbound' ? 'O' : 'I');
              stopDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
          }
        } else {
          stopsDiv.innerHTML += "<p style='text-align:center'>æ‰¾ä¸åˆ°æ­¤è·¯ç·šè³‡æ–™ï¼Œè«‹ç¢ºèªè·¯ç·šè™Ÿç¢¼æˆ–æ–¹å‘ã€‚</p>";
        }
      } catch (error) {
        console.error(error);
        stopsDiv.innerHTML = "<p style='text-align:center'>æŸ¥è©¢å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²çµ¡ã€‚</p>";
      } finally {
          showLoading(false);
      }
    }

async function searchByStopName() {
  const keyword = document.getElementById('route').value.trim();
  if (!keyword) {
      alert("è«‹è¼¸å…¥ç«™åé—œéµå­—");
      return;
  }
  
  showLoading(true);
  const stopsDiv = document.getElementById('stops');
  stopsDiv.innerHTML = "";

  try {
      const stopsUrl = `https://data.etabus.gov.hk/v1/transport/kmb/stop`;
      const stopsRes = await fetch(stopsUrl);
      const stopsData = await stopsRes.json();

      const matchedStops = stopsData.data.filter(s =>
        s.name_tc.includes(keyword) || s.name_en.toLowerCase().includes(keyword.toLowerCase())
      );

      stopsDiv.innerHTML = `<h2>ã€Œ${keyword}ã€æœå°‹çµæœ</h2>`;

      if (matchedStops.length === 0) {
        stopsDiv.innerHTML += "<p style='text-align:center'>æ‰¾ä¸åˆ°ç›¸é—œè»Šç«™</p>";
      } else {
          matchedStops.forEach(stop => {
            const stopDiv = document.createElement('div');
            stopDiv.className = 'stop';
            stopDiv.setAttribute('data-seq', ''); 
            stopDiv.innerHTML = `<div class="stop-name">${stop.name_tc} <span style="font-size:0.8em; color:#888;">${stop.name_en}</span></div>`;

            stopDiv.onclick = () => showRoutesByStop(stop.stop, stopDiv);
            stopsDiv.appendChild(stopDiv);
          });
      }
  } catch(e) {
      stopsDiv.innerHTML = "<p style='text-align:center'>æœå°‹ç™¼ç”ŸéŒ¯èª¤</p>";
  } finally {
      showLoading(false);
  }
}


async function showRoutesByStop(stopId, stopDiv) {
  if (stopDiv.classList.contains('highlight')) return;

  document.querySelectorAll('.eta-detail').forEach(div => div.remove());
  document.querySelectorAll('.stop').forEach(s => s.classList.remove('highlight'));

  stopDiv.classList.add('highlight');

  // âœ… å…ˆæ¸²æŸ“ spinner
  const routeDiv = document.createElement('div');
  routeDiv.className = 'eta-detail expanding';
  routeDiv.style.display = 'block';
  routeDiv.innerHTML = `
    <div style="text-align:center; padding:10px;">
      <div class="spinner" style="width:16px;height:16px;border-width:2px;"></div>
      <div style="color:#666; font-size:13px;">æ­£åœ¨è¼‰å…¥è·¯ç·šè³‡æ–™...</div>
    </div>
  `;
  stopDiv.appendChild(routeDiv);

  try {
    // âœ… è¨˜éŒ„é–‹å§‹æ™‚é–“
    const startTime = Date.now();

    // æ‰“ API
    const res = await fetch(`https://data.etabus.gov.hk/v1/transport/kmb/route-stop`);
    const data = await res.json();
    const routes = data.data.filter(r => r.stop === stopId);

    // âœ… è¨ˆç®—å·²ç¶“éçš„æ™‚é–“
    const elapsed = Date.now() - startTime;

    // å¦‚æœ API < 15 ç§’å°±å›æ‡‰ â†’ ç«‹å³è¼¸å‡ºçµæœ
    if (elapsed < 15000) {
      routeDiv.innerHTML = "";
      renderRoutes(routes, routeDiv, stopDiv, stopId);
    } else {
      // å¦‚æœ API > 15 ç§’æ‰å›æ‡‰ â†’ ç›´æ¥è¼¸å‡ºçµæœ
      routeDiv.innerHTML = "";
      renderRoutes(routes, routeDiv, stopDiv, stopId);
    }
  } catch (error) {
    console.error(error);
    routeDiv.innerHTML = "<div style='padding:10px; color:#999;'>ä¼ºæœå™¨å›æ‡‰æ…¢ï¼Œè«‹ç¨å¾Œå†è©¦</div>";
  }
}

// âœ… æŠ½å‡ºæ¸²æŸ“é‚è¼¯
function renderRoutes(routes, routeDiv, stopDiv, stopId) {
  if (routes.length > 0) {
    routes.sort((a, b) => a.route.localeCompare(b.route, undefined, { numeric: true }));
    routes.forEach(r => {
      // è·¯ç·šæ¨™ç±¤
      const tagWrap = document.createElement('div');
      tagWrap.style.display = 'inline-flex';
      tagWrap.style.alignItems = 'center';
      tagWrap.style.margin = '4px 4px 4px 0';

      const tag = document.createElement('span');
      tag.className = 'route-tag';
      tag.textContent = `${r.route}`;
      tag.onclick = (e) => {
        e.stopPropagation();
        document.getElementById('route').value = r.route;
        currentDirection = (r.dir === 'O') ? 'outbound' : 'inbound';
        getStops(stopId);
        setTimeout(() => {
          stopDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 600);
      };

      // â­ æ”¶è—æŒ‰éˆ•ï¼ˆæŒ‰è·¯ç·šï¼‰
      const favBtn = createRouteFavoriteButton({
        route: r.route,
        // å¯è£œå……é¡¯ç¤ºç”¨åç¨±ï¼ˆä¾‹å¦‚ã€Œèµ·é»âœçµ‚é»ã€ï¼‰ï¼Œé€™è£¡å…ˆç”¨ç°¡å
        nameHTML: r.route
      });

      tagWrap.appendChild(tag);
      tagWrap.appendChild(favBtn);
      routeDiv.appendChild(tagWrap);
    });
  } else {
    routeDiv.innerHTML = "<div style='padding:10px; color:#999;'>æ­¤ç«™æš«ç„¡è·¯ç·šè³‡æ–™</div>";
  }
}

function showFavorites() {
  const favs = getFavorites();
  const stopsDiv = document.getElementById('stops');
  stopsDiv.innerHTML = "<h2>â­ æˆ‘çš„æ”¶è—</h2>";

  if (favs.length === 0) {
    stopsDiv.innerHTML += "<p style='text-align:center'>å°šæœªæ”¶è—ä»»ä½•è·¯ç·š</p>";
    return;
  }

  // ç”¨å¡ç‰‡å±•ç¾æ¯ä¸€æ¢è·¯ç·š
  favs.forEach(f => {
    const card = document.createElement('div');
    card.className = 'stop';
    card.setAttribute('data-seq', ''); 
    card.innerHTML = `<div class="stop-name">è·¯ç·š ${f.route}</div>`;

    // é»å¡ç‰‡ â†’ ç›´æ¥è¼‰å…¥è©²è·¯ç·šï¼ˆæ²¿ç”¨ç¾æœ‰æ–¹å‘ï¼‰
    card.onclick = () => {
      document.getElementById('route').value = f.route;
      getStops(); // ä½¿ç”¨ currentDirection
    };

    // å¡ç‰‡å³ä¸‹è§’åŠ ä¸€å€‹ç§»é™¤æ”¶è—æŒ‰éˆ•
    const removeBtn = document.createElement('button');
    removeBtn.className = 'secondary';
    removeBtn.style.marginTop = '8px';
    removeBtn.textContent = 'ğŸ—‘ï¸ å–æ¶ˆæ”¶è—';
    removeBtn.onclick = (e) => {
      e.stopPropagation();
      toggleFavoriteRoute({ key: makeKey(f.route), type: 'routeOnly', route: f.route, name: f.name });
      showFavorites(); // é‡æ–°æ¸²æŸ“åˆ—è¡¨
    };

    card.appendChild(removeBtn);
    stopsDiv.appendChild(card);
  });
}


async function getETA(stopId, route, stopDiv, dir) {
      // 1. åˆ¤æ–·é€™æ˜¯ä¸æ˜¯ã€Œåˆ·æ–°ã€æ“ä½œ (è©²è»Šç«™å·²ç¶“æ˜¯è¢«é»é¸ç‹€æ…‹)
      const isRefreshing = stopDiv.classList.contains('highlight');

      // 2. å¦‚æœã€Œä¸æ˜¯ã€åˆ·æ–° (ä»£è¡¨é»æ“Šäº†ä¸€å€‹æ–°çš„è»Šç«™)ï¼Œæ‰éœ€è¦æŠŠå…¶ä»–èˆŠçš„é—œæ‰
      if (!isRefreshing) {
          // æ”¶èµ·å…¶ä»–å·²å±•é–‹çš„è»Šç«™
          document.querySelectorAll('.eta-detail').forEach(div => div.remove());
          document.querySelectorAll('.stop').forEach(s => s.classList.remove('highlight'));
          
          // é«˜äº®ç•¶å‰è»Šç«™
          stopDiv.classList.add('highlight');
      }

      // 3. è™•ç†è¨ˆæ™‚å™¨ï¼šç„¡è«–æ˜¯æ–°é»æ“Šé‚„æ˜¯åˆ·æ–°ï¼Œéƒ½è¦å…ˆæ¸…é™¤èˆŠçš„å€’æ•¸è¨ˆæ™‚ï¼Œé¿å…è¨˜æ†¶é«”æ´©æ¼æˆ–æ™‚é–“äº‚è·³
      if (countdownTimers.has(stopDiv)) {
          countdownTimers.get(stopDiv).forEach(id => clearInterval(id));
          countdownTimers.delete(stopDiv);
      }

      // 4. æº–å‚™é¡¯ç¤ºå€åŸŸ
      let etaDiv;
      
      if (isRefreshing) {
          // å¦‚æœæ˜¯åˆ·æ–°ï¼Œç›´æ¥æŠ“å–ç¾æœ‰çš„ div
          etaDiv = stopDiv.querySelector('.eta-detail');
      } else {
          // å¦‚æœæ˜¯æ–°é»æ“Šï¼Œå‰µå»ºæ–°çš„ div
          etaDiv = document.createElement('div');
          etaDiv.className = 'eta-detail';
          stopDiv.appendChild(etaDiv);
          // åŠ å…¥å‹•ç•« class
          requestAnimationFrame(() => etaDiv.classList.add('expanding'));
      }

      // 5. é¡¯ç¤º Loading Spinner (è®“ä½¿ç”¨è€…çŸ¥é“æ­£åœ¨åˆ·æ–°)
      etaDiv.innerHTML = '<div style="text-align:center; padding:10px;"><div class="spinner" style="width:16px;height:16px;border-width:2px;"></div><div style="font-size:12px;color:#999">æ­£åœ¨æ›´æ–°...</div></div>';

      const url = `https://data.etabus.gov.hk/v1/transport/kmb/eta/${stopId}/${route}/${serviceType}`;

      try {
        const response = await fetch(url);
        const data = await response.json();
        const etaList = data.data || [];
        const listForDir = etaList.filter(e => e.dir === dir);

        etaDiv.innerHTML = ""; // æ¸…ç©º Loading

        if (listForDir.length === 0) {
          etaDiv.innerHTML = "<div style='padding:10px; color:#999;'>æš«ç„¡ç­æ¬¡è³‡æ–™</div>";
          return;
        }

        const intervals = [];

        listForDir.forEach(e => {
          const itemRow = document.createElement('div');
          itemRow.className = 'eta-item';
          
          const remark = e.rmk_tc || "";
          const dest = e.dest_tc || "";

          // çµæ§‹ï¼šæ™‚é–“(å·¦) + ç›®çš„åœ°/å‚™è¨»(å³)
          itemRow.innerHTML = `
            <div class="eta-time">-- <small>åˆ†</small></div>
            <div class="eta-dest">å¾€ ${dest} <span>${remark}</span></div>
          `;

          const timeEl = itemRow.querySelector('.eta-time');

          if (!e.eta) {
            timeEl.innerHTML = `<span style="font-size:16px; color:#999;">æ²’æœ‰æ™‚é–“</span>`;
          } else {
            const etaTime = new Date(e.eta);

            function updateCountdown() {
              const now = new Date();
              const diff = etaTime - now;

              if (diff > 0) {
                const minutes = Math.floor(diff / 60000);
                const seconds = Math.floor((diff % 60000) / 1000);

                if (minutes === 0) {
                    timeEl.innerHTML = `${seconds}<small>ç§’</small>`;
                    timeEl.style.color = "var(--primary-color)"; 
                } else if (minutes < 5) {
                     timeEl.innerHTML = `${minutes}<small>åˆ†</small>${seconds}<small>ç§’</small>`;
                     timeEl.style.color = "#d66d00"; 
                } else {
                    timeEl.innerHTML = `${minutes}<small>åˆ†</small>`;
                    timeEl.style.color = "var(--text-main)"; 
                }
              } else {
                timeEl.innerHTML = "å·²åˆ°é”";
                timeEl.style.color = "#999";
              }
            }

            updateCountdown();
            const id = setInterval(updateCountdown, 1000);
            intervals.push(id);
          }
          
          etaDiv.appendChild(itemRow);
        });

        countdownTimers.set(stopDiv, intervals);

      } catch (error) {
        console.error(error);
        etaDiv.innerHTML = "<div style='padding:10px; color:red; text-align:center'>æ›´æ–°å¤±æ•—ï¼Œè«‹é‡è©¦</div>";
      }
    }

    function toggleDirection() {
      currentDirection = currentDirection === 'outbound' ? 'inbound' : 'outbound';
      const routeVal = document.getElementById('route').value;
      if(routeVal) {
          getStops();
      } else {
          // åªåˆ‡æ›ç‹€æ…‹ï¼Œçµ¦å€‹æç¤º
          const btn = document.querySelector('button[onclick="toggleDirection()"]');
          btn.textContent = currentDirection === 'outbound' ? 'ç¾åœ¨æ˜¯: å»ç¨‹' : 'ç¾åœ¨æ˜¯: å›ç¨‹';
          setTimeout(() => btn.textContent = 'â‡… è½‰æ–¹å‘', 1000);
      }
    }
  </script>
</body>
</html>

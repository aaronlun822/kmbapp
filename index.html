<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="UTF-8">
  <title>ä¹å·´åˆ°ç«™æŸ¥è©¢</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: "Microsoft JhengHei", Arial, sans-serif;
      margin: 0;
      background: #f9f9f9;
      color: #333;
    }
    h1 {
      text-align: center;
      color: #d32f2f;
      font-size: clamp(20px, 6vw, 28px);
      margin: 10px 0;
    }
    /* å›ºå®šå·¥å…·åˆ— */
    #toolbar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: #fff;
      padding: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      z-index: 1000;
      text-align: center;
    }
    #content {
      margin-top: 100px; /* é ç•™å·¥å…·åˆ—é«˜åº¦ */
      padding: 10px;
    }
    label, input, button {
      font-size: clamp(14px, 4vw, 18px);
    }
    input {
      padding: 5px;
      width: clamp(120px, 40vw, 200px);
      text-align: center;
    }
    button {
      padding: 8px 12px;
      margin: 5px;
      background: #d32f2f;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: clamp(14px, 4vw, 18px);
    }
    button:hover {
      background: #b71c1c;
    }
    #stops {
      margin-top: 15px;
      background: white;
      border-radius: 6px;
      padding: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .stop {
      padding: 10px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
      transition: background 0.2s;
      font-size: clamp(14px, 4vw, 18px);
      word-wrap: break-word;
    }
    .stop:hover {
      background: #f1f1f1;
    }
    .eta, .eta-detail {
      margin-top: 5px;
      padding-left: 10px;
      font-size: clamp(12px, 3.5vw, 16px);
      color: #2e7d32;
    }
    .eta span, .eta-detail span {
      display: block;
      margin: 5px 0;
      background: #e8f5e9;
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
    }
    /* é«˜äº®é¡¯ç¤ºå·²å±•é–‹çš„ç«™ */
    .highlight {
      background: #fff3e0;
      border-left: 4px solid #ff9800;
    }
	/* ETA å€å¡Šæ”¶åˆå‹•ç•« */
	.eta-detail {
	  max-height: 500px;
	  overflow: hidden;
	  transition: max-height 0.5s ease, opacity 0.5s ease;
	  opacity: 1;
	}
	.eta-detail.collapsing {
	  max-height: 0;
	  opacity: 0;
	}
	.eta-detail.expanding {
	  max-height: 500px; /* è¶³å¤ å®¹ç´å…§å®¹ */
	  opacity: 1;
	}

  </style>
</head>
<body>
  <div id="toolbar">
    <h1>ä¹å·´åˆ°ç«™æŸ¥è©¢</h1>
    <label>
      <input type="text" id="route" placeholder="è«‹è¼¸å…¥è·¯ç·šæˆ–ç«™å">
    </label>
    <button onclick="getStops()">æŸ¥è©¢è·¯ç·š</button>
    <button onclick="searchByStopName()">æœå°‹ç«™å</button>
    <button onclick="toggleDirection()">æ›´æ›æ–¹å‘</button>
  </div>

  <div id="content">
    <div id="stops"></div>
  </div>
  <script>
    let currentDirection = 'outbound'; // outbound = å»ç¨‹, inbound = å›ç¨‹
    const serviceType = 1; // ä¸€èˆ¬è·¯ç·šéƒ½æ˜¯ 1
    const countdownTimers = new Map();

    async function getStopName(stopId) {
      const url = `https://data.etabus.gov.hk/v1/transport/kmb/stop/${stopId}`;
      try {
        const response = await fetch(url);
        const data = await response.json();
        if (data.data) {
          return `${data.data.name_tc} / ${data.data.name_en}`;
        } else {
          return stopId;
        }
      } catch (error) {
        console.error(error);
        return stopId;
      }
    }

    async function getStops(highlightStopId = null) {
      const route = document.getElementById('route').value.trim().toUpperCase();
      const routeInfoUrl = `https://data.etabus.gov.hk/v1/transport/kmb/route/${route}/${currentDirection}/${serviceType}`;
      const routeInfoRes = await fetch(routeInfoUrl);
      const routeInfoData = await routeInfoRes.json();
      let titleText = `è·¯ç·š ${route}`;
      if (routeInfoData.data) {
        titleText = `${routeInfoData.data.orig_tc} â†’ ${routeInfoData.data.dest_tc}`;
      }

      const url = `https://data.etabus.gov.hk/v1/transport/kmb/route-stop/${route}/${currentDirection}/${serviceType}`;
      try {
        const response = await fetch(url);
        const data = await response.json();

        const stopsDiv = document.getElementById('stops');
        stopsDiv.innerHTML = `<h2 style="font-size:clamp(16px,5vw,22px);text-align:center;">${titleText}</h2>`;

        if (data.data && data.data.length > 0) {
          for (const stop of data.data) {
            const stopName = await getStopName(stop.stop);
            const stopDiv = document.createElement('div');
            stopDiv.className = 'stop';
            stopDiv.textContent = `${stop.seq}. ${stopName}`;
            stopDiv.onclick = () => getETA(stop.stop, route, stopDiv, currentDirection === 'outbound' ? 'O' : 'I');
            stopsDiv.appendChild(stopDiv);

            // å¦‚æœæœ‰ highlightStopIdï¼Œå‰‡è‡ªå‹•å±•é–‹è©²ç«™
            if (highlightStopId && stop.stop === highlightStopId) {
              getETA(stop.stop, route, stopDiv, currentDirection === 'outbound' ? 'O' : 'I');
            }
          }
        } else {
          stopsDiv.innerHTML += "<p>æ‰¾ä¸åˆ°è»Šç«™è³‡æ–™</p>";
        }
      } catch (error) {
        console.error(error);
        document.getElementById('stops').innerHTML = "<p>æŸ¥è©¢å¤±æ•—</p>";
      }
    }
    async function searchByStopName() {
      const keyword = document.getElementById('route').value.trim();
      if (!keyword) return;

      const stopsUrl = `https://data.etabus.gov.hk/v1/transport/kmb/stop`;
      const stopsRes = await fetch(stopsUrl);
      const stopsData = await stopsRes.json();

      const matchedStops = stopsData.data.filter(s =>
        s.name_tc.includes(keyword) || s.name_en.toLowerCase().includes(keyword.toLowerCase())
      );

      const stopsDiv = document.getElementById('stops');
      stopsDiv.innerHTML = `<h2 style="font-size:clamp(16px,5vw,22px);text-align:center;">æœå°‹ã€Œ${keyword}ã€çµæœ</h2>`;

      if (matchedStops.length === 0) {
        stopsDiv.innerHTML += "<p>æ‰¾ä¸åˆ°ç›¸é—œè»Šç«™</p>";
        return;
      }

      matchedStops.forEach(stop => {
        const stopDiv = document.createElement('div');
        stopDiv.className = 'stop';
        stopDiv.textContent = `${stop.name_tc} / ${stop.name_en}`;
        stopDiv.onclick = () => showRoutesByStop(stop.stop, stopDiv);
        stopsDiv.appendChild(stopDiv);
      });
    }

    async function showRoutesByStop(stopId, stopDiv) {
      const url = `https://data.etabus.gov.hk/v1/transport/kmb/route-stop`;
      const res = await fetch(url);
      const data = await res.json();

      const routes = data.data.filter(r => r.stop === stopId);

      const oldRoutes = stopDiv.querySelector('.eta');
      if (oldRoutes) oldRoutes.remove();

      const routeDiv = document.createElement('div');
      routeDiv.className = 'eta';

      if (routes.length > 0) {
        routes.forEach(r => {
          const span = document.createElement('span');
          span.textContent = `è·¯ç·š ${r.route} (${r.dir === 'O' ? 'å»ç¨‹' : 'å›ç¨‹'})`;
          // å°å‘ getStops ä¸¦è‡ªå‹•å±•é–‹è©²ç«™
          span.onclick = () => {
            document.getElementById('route').value = r.route;
            currentDirection = (r.dir === 'O') ? 'outbound' : 'inbound';
            getStops(stopId); // å‚³å…¥ stopIdï¼Œè®“ getStops è‡ªå‹•å±•é–‹
          };
          routeDiv.appendChild(span);
        });
      } else {
        routeDiv.textContent = "æš«ç„¡è·¯ç·šè³‡æ–™";
      }

      stopDiv.appendChild(routeDiv);
    }

    async function getETA(stopId, route, stopDiv, dir) {
      const url = `https://data.etabus.gov.hk/v1/transport/kmb/eta/${stopId}/${route}/${serviceType}`;
      try {
        const response = await fetch(url);
        const data = await response.json();

        const etaList = data.data || [];
		
		// æ”¶èµ·å…¶ä»–å·²å±•é–‹çš„ç«™ï¼ˆåŠ å‹•ç•«ï¼‰
		document.querySelectorAll('.eta-detail').forEach(div => {
		  div.classList.add('collapsing');
		  setTimeout(() => div.remove(), 500); // ç­‰å‹•ç•«çµæŸå†ç§»é™¤
		});
		document.querySelectorAll('.stop').forEach(s => s.classList.remove('highlight'));

        const oldEtaDetail = stopDiv.querySelector('.eta-detail');
        if (oldEtaDetail) oldEtaDetail.remove();

        if (countdownTimers.has(stopDiv)) {
          countdownTimers.get(stopDiv).forEach(id => clearInterval(id));
          countdownTimers.delete(stopDiv);
        }

const etaDiv = document.createElement('div');
etaDiv.className = 'eta-detail';
stopDiv.appendChild(etaDiv);

// è§¸ç™¼å±•é–‹å‹•ç•«
requestAnimationFrame(() => {
  etaDiv.classList.add('expanding');
});

        const listForDir = etaList.filter(e => e.dir === dir);

        if (listForDir.length === 0) {
          etaDiv.textContent = "æš«ç„¡ç­æ¬¡";
          return;
        }

        const intervals = [];

        listForDir.forEach(e => {
          const row = document.createElement('span');
          const remark = e.rmk_tc || e.rmk_en || "";
          const dest = e.dest_tc || e.dest_en || "";

          if (!e.eta) {
            row.textContent = remark ? `æš«ç„¡ç­æ¬¡ï¼ˆ${remark}ï¼‰` : "æš«ç„¡ç­æ¬¡";
            etaDiv.appendChild(row);
            return;
          }

          const etaTime = new Date(e.eta);

          function updateCountdown() {
            const now = new Date();
            const diff = etaTime - now;

            if (diff > 0) {
              const minutes = Math.floor(diff / 60000);
              const seconds = Math.floor((diff % 60000) / 1000);

              const timeText = minutes < 3
                ? `${minutes}åˆ†${seconds}ç§’`
                : `${minutes}åˆ†`;

              row.textContent = `ğŸšŒ ${timeText} â†’ ${dest}${remark ? `ï¼ˆ${remark}ï¼‰` : ""}`;
            } else {
              row.textContent = "ğŸšŒ å·²åˆ°ç«™";
            }
          }

          updateCountdown();
          const id = setInterval(updateCountdown, 1000);
          intervals.push(id);

          etaDiv.appendChild(row);
        });

        countdownTimers.set(stopDiv, intervals);

        // é«˜äº®é¡¯ç¤ºå±•é–‹çš„ç«™
        document.querySelectorAll('.stop').forEach(s => s.classList.remove('highlight'));
        stopDiv.classList.add('highlight');
      } catch (error) {
        console.error(error);
        const oldEtaDetail = stopDiv.querySelector('.eta-detail');
        if (oldEtaDetail) oldEtaDetail.remove();
        const etaDiv = document.createElement('div');
        etaDiv.className = 'eta-detail';
        etaDiv.textContent = "æŸ¥è©¢å¤±æ•—";
        stopDiv.appendChild(etaDiv);
      }
    }

    function toggleDirection() {
      currentDirection = currentDirection === 'outbound' ? 'inbound' : 'outbound';
      getStops();
    }
  </script>
</body>
</html>
